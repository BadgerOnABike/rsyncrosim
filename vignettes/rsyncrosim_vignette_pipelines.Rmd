---
title: '`rsyncrosim`: introduction to pipelines'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{`rsyncrosim`: introduction to pipelines}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
params:
  EVAL: !r identical(Sys.getenv("NOT_CRAN"), "true")
---

This vignette will cover how to use model pipelines using the `rsyncrosim` package within the <a href="https://syncrosim.com/" target="_blank">SyncroSim</a> software framework. For an overview of <a href="https://syncrosim.com/" target="_blank">SyncroSim</a> and <a href="https://cran.r-project.org/web/packages/rsyncrosim/index.html" target="_blank">`rsyncrosim`</a>, as well as a basic usage tutorial for `rsyncrosim`, see the [Introduction to `rsyncrosim`](https://syncrosim.github.io/rsyncrosim/rsyncrosim_vignette_basic.html) vignette. To learn how to use iterations in the `rsyncrosim` interface, see the [`rsyncrosim`: introduction to uncertainty](https://syncrosim.github.io/rsyncrosim/rsyncrosim_vignette_uncertainty.html) vignette.


## SyncroSim Package: `helloworldPipeline`


To demonstrate how to link models in a pipeline using the `rsyncrosim` interface, we will need the <a href="https://github.com/ApexRMS/helloworldPipeline" target="_blank">helloworldPipeline</a> SyncroSim package. `helloworldPipeline` was designed to be a simple package to introduce pipelines to SyncroSim modeling workflows. Models connected by pipelines are useful as the user can now access intermediate outputs without having to create multiple Scenarios.

The package takes from the user 3 inputs, *mMean*, *mSD*, and *b*. For each iteration, a value *m*, representing the slope, is sampled from a normal distribution with mean of *mMean* and standard deviation of *mSD*. The *b* value represents the intercept. In the first model in the pipeline, these input values are run through a linear model, *y=mt+b*, where *t* is *time*, and returns the *y* value as output. The second model takes *y* as input and calculates the cumulative sum of *y* over time.

![Infographic of helloworldPipeline package](./infographic.png)

For more details on the different features of the `helloworldPipeline` SyncroSim package, consult the SyncroSim <a href="https://docs.syncrosim.com/how_to_guides/package_create_pipelines.html" target="_blank">Enhancing a Package: Linking Models</a> tutorial.


## Setup


### Install SyncroSim

Before using `rsyncrosim` you will first need to <a href="https://syncrosim.com/download/" target="_blank">download and install</a> the SyncroSim software. Versions of SyncroSim exist for both Windows and Linux.

### Installing and loading R packages

You will need to install the `rsyncrosim` R package, either using <a href="https://cran.r-project.org/" target="_blank">CRAN</a> or from the `rsyncrosim` <a href="https://github.com/syncrosim/rsyncrosim/releases/" target="_blank">GitHub repository</a>. Versions of `rsyncrosim` are available for both Windows and Linux.

In a new R script, load the `rsyncrosim` package.

```{r load packages}
# Load R package for working with SyncroSim
library(rsyncrosim)
```

### Installing SyncroSim packages using `addPackage()`

Check if the <a href="https://github.com/ApexRMS/helloworldPipeline" target="_blank">helloworldPipeline</a> package is already installed. Use the `package()` function from `rsyncrosim` to first get a list of all currently installed packages in SyncroSim.

```{r delete SyncroSim packages, echo = FALSE, results = FALSE, message = FALSE}
installedPackages <- package()
if (is.element("demosales", installedPackages$name)) removePackage("demosales", force = TRUE)
if (is.element("dgsim", installedPackages$name)) removePackage("dgsim", force = TRUE)
if (is.element("epi", installedPackages$name)) removePackage("epi", force = TRUE)
if (is.element("helloworld", installedPackages$name)) removePackage("helloworld", force = TRUE)
if (is.element("helloworldEnhanced", installedPackages$name)) removePackage("helloworldEnhanced", force = TRUE)
if (is.element("helloworldTime", installedPackages$name)) removePackage("helloworldTime", force = TRUE)
if (is.element("helloworldUncertainty", installedPackages$name)) removePackage("helloworldUncertainty", force = TRUE)
if (is.element("helloworldPipeline", installedPackages$name)) removePackage("helloworldPipeline", force = TRUE)
if (is.element("helloworldSpatial", installedPackages$name)) removePackage("helloworldSpatial", force = TRUE)
if (is.element("landfirevegmodels", installedPackages$name)) removePackage("landfirevegmodels", force = TRUE)
if (is.element("stsim", installedPackages$name)) removePackage("stsim", force = TRUE)
if (is.element("stsimsf", installedPackages$name)) removePackage("stsimsf", force = TRUE)
```


```{r check packages 1, warning = FALSE}
# Get list of installed packages
package()
```

Currently we do not have the `helloworldPipeline` package installed! Install `helloworldPipeline` using the `rynscrosim` function `addPackage()`. This function takes a package name as input and then queries the SyncroSim package server for the specified package.

```{r add package from server, warning = FALSE}
# Install helloworldPipeline
addPackage("helloworldPipeline")
```

Now `helloworldPipeline` should now be included in the package list:

```{r check packages 2, warning = FALSE}
# Get list of installed packages
package()
```


*Note:* you can also update installed packages using the `updatePackage()` function or delete installed packages using the `removePackage()` function in `rsyncrosim`.

### Connecting R to SyncroSim using `session()`

Connect to your installed copy of the SyncroSim software using `session()`. The first argument is a path to the folder on your computer where SyncroSim has been installed. If the first argument is left blank, then the default install folder is used (Windows only).

```{r load session not run, warning = FALSE, eval = FALSE}
mySession <- session("path/to/install_folder")      # Create a Session based SyncroSim install folder
mySession <- session()                              # Using default install folder (Windows only)
mySession                                           # Displays the Session object
```

```{r load session run, warning = FALSE, eval = TRUE, echo = FALSE}
# Results of this code shown for above
mySession <- session()                              # Using default install folder (Windows only)
mySession                                           # Displays the Session object
```

You can check to see which version of SyncroSim your R script is connected to by running the `version()` function.

```{r check version, warning = FALSE}
version(mySession)
```


## Create a modeling workflow


When creating a new modeling workflow from scratch, we need to create objects of the following scopes:

* <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Library</a>
* <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Projects</a>
* <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Scenarios</a>

For more information on these scopes, see the [Introduction to `rsyncrosim`](https://syncrosim.github.io/rsyncrosim/rsyncrosim_vignette_basic.html) vignette.

### Set up Library, Project, and Scenario

```{r create Library, warning = FALSE}
# Create a new Library
myLibrary <- ssimLibrary(name = "helloworldLibrary.ssim",
                         session = mySession,
                         package = "helloworldPipeline",
                         overwrite = TRUE)

# Open the default Project
myProject = project(ssimObject = myLibrary, project = "Definitions")

# Create a new Scenario (associated with the default Project)
myScenario = scenario(ssimObject = myProject, scenario = "My first scenario")
```

### View model inputs using `datasheet()`
  
View the Datasheets associated with your new Scenario using the `datasheet()` function from `rsyncrosim`.

```{r view datasheet list, warning = FALSE}
# View all Datasheets associated with a Library, Project, or Scenario
datasheet(myScenario)
```

From the list of Datasheets above, we can see that there are 4 Datasheets specific to the `helloworldPipeline` package, including an Input Datasheet, an Intermediate Datasheet, and an Output Datasheet. The Intermediate Datasheet will comprise of the results from the first model in our workflow, whereas the Output Datasheet will comprise of the results from the second model.

### Configure model inputs using `datasheet()` and `addRow()`

**Input Datasheet**

Currently our input Scenario Datasheets are empty! We need to add some values to our input Datasheet (`InputDatasheet`) so we can run our model. First, assign the Input Datasheet to a new data frame variable, then check the columns that need input values. We can assign the Input Datasheet to an R data frame using the `datasheet()` function in `rsyncrosim`.

```{r assign input data, warning = FALSE}
# Assign input Datasheet to a new data frame variable
myInputDataframe <- datasheet(myScenario,
                              name = "helloworldPipeline_InputDatasheet")

# Check the columns of the input data frame
str(myInputDataframe)
```

The input Datasheet requires 3 values:

* `mMean` : the mean of the slope normal distribution.
* `mSD` : the standard deviation of the slope normal distribution.
* `b` : the intercept of the linear equation.

Add these values to a new data frame, then use the `addRow()` function from `rsyncrosim` to update the input Datasheet.

```{r add input data not run, warning = FALSE}
# Create input data and add it to the input data frame
myInputRow <- data.frame(mMean = 2, mSD = 4, b = 3)
myInputDataframe <- addRow(myInputDataframe, myInputRow)

# Check values
myInputDataframe
```

Finally, save the updated R data frame as a Datasheet using `saveDatasheet()`.

```{r save input data, warning = FALSE}
# Save input R data frame as a SyncroSim Datasheet
saveDatasheet(ssimObject = myScenario, data = myInputDataframe,
              name = "helloworldPipeline_InputDatasheet")
```

**RunControl Datasheet**

The `RunControl` Datasheet provides information about how many time steps and iterations to use in the model. Here, we set the number of iterations, as well as the minimum and maximum time steps for our model. Let's take a look at the columns that need input values. 

```{r modify run control}
# Assign run control Datasheet to a new data frame variable
runSettings <- datasheet(myScenario, name = "helloworldPipeline_RunControl")

# Check the columns of the run control data frame
str(runSettings)
```

The RunControl Datasheet requires the following 4 columns:

* `MinimumIteration` : starting value of iterations (default=1).
* `MaximumIteration` : total number of iterations to run the model for.
* `MinimumTimestep` : the starting time point of the simulation.
* `MaximumTimestep` : the end time point of the simulation.

We'll add this information to an R data frame and then add it to the Run Control Datasheet using `addRow()`.

```{r}
# Create run control data and add it to the run control data frame
runSettingsRow <- data.frame(MinimumIteration = 1,
                             MaximumIteration = 5,
                             MinimumTimestep = 1,
                             MaximumTimestep = 10)
runSettings <- addRow(runSettings, runSettingsRow)

# Check values
runSettings
```

Finally, save the R data frame as a Datasheet using `saveDatasheet()`.

```{r}
# Save run control R data frame as a SyncroSim Datasheet
saveDatasheet(ssimObject = myScenario, data = runSettings,
              name = "helloworldPipeline_RunControl")
```

**Pipeline Datasheet**

This packages makes use of pipelines to link the output of one model to the input of a second model. To implement pipelines in our package, we need to specify the order in which to run the two models in our Pipeline by editing the `Pipeline` Datasheet. The `Pipeline` Datasheet is part of the built-in SyncroSim core, so we access it using the "core_" prefix with the `datasheet()` function. From viewing the structure of the `Pipeline` Datasheet we know that the `StageNameID` is a factor with 2 levels: "First Model" and "Second Model". We will set the data for this Datasheet such that "First Model" is run first, then "Second Model". This way, the output from "First Model" is used as the input for "Second Model".

```{r modify pipeline, eval = FALSE}
# Assign Pipeline Datasheet to a new data frame variable
myPipelineDataframe <- datasheet(myScenario, name = "core_Pipeline")

# Check the columns of the Pipeline data frame
str(myPipelineDataframe)

# Create Pipeline data and add it to the Pipeline data frame
myPipelineRow <- data.frame(StageNameID = c("First Model", "Second Model"),
                            RunOrder = c(1, 2))

myPipelineDataframe <- addRow(myPipelineDataframe, myPipelineRow)

# Check values
myPipelineDataframe

# Save Pipeline R data frame as a SyncroSim Datasheet
saveDatasheet(ssimObject = myScenario, data = myPipelineDataframe,
              name = "core_Pipeline")
```

## Run Scenarios

### Setting run parameters with `run()`

We will now run our Scenario using the `run()` function in `rsyncrosim`. If we have a large model and we want to parallelize the run using multiprocessing, we can set the `jobs` argument to be a value greater than 1.

```{r run first Scenario, warning = FALSE}
# Run the first Scenario we created
myResultScenario <- run(myScenario, jobs = 5)
```


## View results


### Viewing intermediate results with `datasheet()`

The next step is to view the intermediate output of the results Scenario. We can load the result tables using the `datasheet()` function. The Intermediate Datasheet corresponds to the results from the first model.


```{r view results datasheets for model 1, warning = FALSE}
# Results of first Scenario
resultsSummary <- datasheet(myResultScenario,
                            name = "helloworldPipeline_IntermediateDatasheet")

# View results table
head(resultsSummary)
```

We can see that for every timestep in an iteration we have a new value of *y* corresponding to *y=mt+b*.

### Viewing final results with `datasheet()`

Now, we can view the results of the second model, also using `datasheet()`. The Output Datasheet corresponds to the results from the second model.

```{r view results datasheets for model 2, warning = FALSE}
# Results of first Scenario
resultsSummary <- datasheet(myResultScenario,
                            name = "helloworldPipeline_OutputDatasheet")

# View results table
head(resultsSummary)
```

We can see for each timestep in an iteration, we have a new value of *yCum*, representing the cumulative value of *y* over time.