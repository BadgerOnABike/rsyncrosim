---
title: "`rsyncrosim`: introduction to spatial data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{`rsyncrosim`: introduction to spatial data}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
params:
  EVAL: !r identical(Sys.getenv("NOT_CRAN"), "true")
---

This vignette will cover incorporating spatial data into SyncroSim models using the `rsyncrosim` package within the <a href="https://syncrosim.com/" target="_blank">SyncroSim</a> software framework. For an overview of <a href="https://syncrosim.com/" target="_blank">SyncroSim</a> and <a href="https://cran.r-project.org/web/packages/rsyncrosim/index.html" target="_blank">`rsyncrosim`</a>, as well as a basic usage tutorial for `rsyncrosim`, see the [Introduction to `rsyncrosim`](https://syncrosim.github.io/rsyncrosim/rsyncrosim_vignette_basic.html) vignette. To learn how to use iterations in the `rsyncrosim` interface, see the [`rsyncrosim`: introduction to uncertainty](https://syncrosim.github.io/rsyncrosim/rsyncrosim_vignette_uncertainty.html) vignette. To learn how to link models using pipelines in the `rsyncrosim` interface, see the [`rsyncrosim`: introduction to pipelines](https://syncrosim.github.io/rsyncrosim/rsyncrosim_vignette_pipelines.html) vignette.


## SyncroSim Package: helloworldSpatial


To demonstrate how to use spatial data in the `rsyncrosim` interface, we will be using the <a href="https://github.com/ApexRMS/helloworldSpatial" target="_blank">helloworldSpatial</a> SyncroSim package. `helloworldSpatial` was designed to be a simple package to show off some key functionalities of SyncroSim, including the ability to use both spatial and non-spatial data.

The package takes 3 inputs, *mMean*, *mSD*, and a spatial raster file of intercept (*b*) values. For each iteration, a value *m*, representing the slope, is sampled from a normal distribution with mean of *mMean* and standard deviation of *mSD*. These values are run through 2 models to produce both spatial and non-spatial outputs.

![Infographic of helloworldSpatial package](./infographic.png)

For more details on the different features of the `helloworldSpatial` SyncroSim package, consult the SyncroSim <a href="https://docs.syncrosim.com/how_to_guides/package_create_spatial.html" target="_blank">Enhancing a Package: Integrating Spatial Data</a> tutorial.


## Setup


### Install SyncroSim

Before using `rsyncrosim` you will first need to <a href="https://syncrosim.com/download/" target="_blank">download and install</a> the SyncroSim software. Versions of SyncroSim exist for both Windows and Linux.

### Installing and loading R packages

You will need to install the `rsyncrosim` R package, either using <a href="https://cran.r-project.org/" target="_blank">CRAN</a> or from the `rsyncrosim` <a href="https://github.com/syncrosim/rsyncrosim/releases/" target="_blank">GitHub repository</a>. Versions of `rsyncrosim` are available for both Windows and Linux. You may need to install the `raster` and `rgdal` packages from CRAN as well.

In a new R script, load the necessary packages. This includes the `rsyncrosim` and `raster` R packages.

```{r load packages}
# Load R packages
library(rsyncrosim)  # package for working with SyncroSim
library(raster)      # package for working with raster data
```

### Installing SyncroSim packages using `addPackage()`

Check if the <a href="https://github.com/ApexRMS/helloworldSpatial" target="_blank">helloworldSpatial</a> package is already installed. Use the `package()` function from `rsyncrosim` to first get a list of all currently installed packages in SyncroSim.

```{r delete SyncroSim packages, echo = FALSE, results = FALSE, message = FALSE}
installedPackages <- package()
if (is.element("demosales", installedPackages$name)) removePackage("demosales", force = TRUE)
if (is.element("dgsim", installedPackages$name)) removePackage("dgsim", force = TRUE)
if (is.element("epi", installedPackages$name)) removePackage("epi", force = TRUE)
if (is.element("helloworld", installedPackages$name)) removePackage("helloworld", force = TRUE)
if (is.element("helloworldEnhanced", installedPackages$name)) removePackage("helloworldEnhanced", force = TRUE)
if (is.element("helloworldTime", installedPackages$name)) removePackage("helloworldTime", force = TRUE)
if (is.element("helloworldUncertainty", installedPackages$name)) removePackage("helloworldUncertainty", force = TRUE)
if (is.element("helloworldPipeline", installedPackages$name)) removePackage("helloworldPipeline", force = TRUE)
if (is.element("helloworldSpatial", installedPackages$name)) removePackage("helloworldSpatial", force = TRUE)
if (is.element("landfirevegmodels", installedPackages$name)) removePackage("landfirevegmodels", force = TRUE)
if (is.element("stsim", installedPackages$name)) removePackage("stsim", force = TRUE)
if (is.element("stsimsf", installedPackages$name)) removePackage("stsimsf", force = TRUE)
```


```{r check packages 1, warning = FALSE}
# Get list of installed packages
package()
```

Currently we do not have the `helloworldSpatial` package installed! Install `helloworldSpatial` using the `rynscrosim` function `addPackage()`. This function takes a package name as input and then queries the SyncroSim package server for the specified package.

```{r add package from server, warning = FALSE}
# Install helloworldSpatial
addPackage("helloworldSpatial")
```

Now `helloworldSpatial` should now be included in the package list:

```{r check packages 2, warning = FALSE}
# Get list of installed packages
package()
```


*Note:* you can also update installed packages using the `updatePackage()` function or delete installed packages using the `removePackage()` function in `rsyncrosim`

### Connecting R to SyncroSim using `session()`

Connect to your installed copy of the SyncroSim software using `session()`. The first argument is a path to the folder on your computer where SyncroSim has been installed. If the first argument is left blank, then the default install folder is used (Windows only).

```{r load session not run, warning = FALSE, eval = FALSE}
mySession <- session("path/to/install_folder")      # Create a Session based SyncroSim install folder
mySession <- session()                              # Using default install folder (Windows only)
mySession                                           # Displays the Session object
```

```{r load session run, warning = FALSE, eval = TRUE, echo = FALSE}
# Results of this code shown for above
mySession <- session()                              # Using default install folder (Windows only)
mySession                                           # Displays the Session object
```

You can check to see which version of SyncroSim your R script is connected to by running the `version()` function.

```{r check version, warning = FALSE}
version(mySession)
```


## Create a modeling workflow


When creating a new modeling workflow from scratch, we need to create objects of the following scopes:

* <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Library</a>
* <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Projects</a>
* <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Scenarios</a>

For more information on these scopes, see the [Introduction to `rsyncrosim`](https://syncrosim.github.io/rsyncrosim/rsyncrosim_vignette_basic.html) vignette.

### Set up Library, Project, and Scenario

```{r create Library, warning = FALSE}
# Create a new Library
myLibrary <- ssimLibrary(name = "helloworldLibrary.ssim",
                         session = mySession,
                         package = "helloworldSpatial",
                         overwrite = TRUE)

# Open the default Project
myProject = project(ssimObject = myLibrary, project = "Definitions")

# Create a new Scenario (associated with the default Project)
myScenario = scenario(ssimObject = myProject, scenario = "My spatial scenario")
```

### View model inputs using `datasheet()`
  
View the Datasheets associated with your new Scenario using the `datasheet()` function from `rsyncrosim`.

```{r view datasheet list, warning = FALSE}
# View all Datasheets associated with a Library, Project, or Scenario
datasheet(myScenario)
```

From the list of Datasheets above, we can see that there are 4 Datasheets specific to the `helloworldSpatial` package, including an Input Datasheet, an Intermediate Datasheet, an Output Datasheet, and a Run Control Datasheet.

### Configure model inputs using `datasheet()` and `addRow()`

Currently our input Scenario Datasheets are empty! We need to add some values to our input Datasheet (`InputDatasheet`) and run control Datasheet (`RunControl`) so we can run our model. Since this package also uses pipelines, we also need to add some information to the core `Pipeline` Datasheet to specify which models are run in which order.

**Input Datasheet**

First, assign the input Datasheet to a new data frame variable, then check the columns that need input values. We can assign the input Datasheet to an R data frame using the `datasheet()` function in `rsyncrosim`.

```{r assign input data, warning = FALSE}
# Assign input Datasheet to a new data frame variable
myInputDataframe <- datasheet(myScenario,
                              name = "helloworldSpatial_InputDatasheet")

# Check the columns of the input data frame
str(myInputDataframe)
```

Notice that the type of the `InterceptRasterFile` is a character. This is because it is a file path to an external file.

The input Datasheet requires 3 values:

* `mMean` : the mean of a normal distribution that will determine the slope of the linear equation.
* `mSD` : the standard deviation of a normal distribution that will determine the slope of the linear equation.
* `InterceptRasterFile` : the file path to a raster image, in which each cell of the image will be an intercept in the linear equation.

In this example, the external file we are using for the `InterceptRasterFile` is a simple 5x5 raster TIF file generated using the `raster` package in R. The file used in this vignete can be found <a href="https://github.com/ApexRMS/helloworldSpatial/blob/main/images/input-raster.tif" target="_blank">here</a>.

![raster image used](./input-raster.png)

Add these values to a new data frame, then use the `addRow()` function from `rsyncrosim` to update the input Datasheet.

```{r add input data not run, warning = FALSE}
# Create input data and add it to the input data frame
myInputRow <- data.frame(mMean = 0, mSD = 4,
                         InterceptRasterFile = "path/to/raster-image.tif")
myInputDataframe <- addRow(myInputDataframe, myInputRow)

# Check values
myInputDataframe
```

```{r add input data run, warning = FALSE, echo = FALSE, results = FALSE}
# Create input data and add it to the input data frame
myInputDataframe <- data.frame(
  mMean = 0, mSD = 4,
  InterceptRasterFile = here::here("vignettes", "input-raster.tif"))
```

Finally, save the updated input Datasheet to the Library, Project, and/or Scenario using the `saveDatasheet()` function.

```{r save input data, warning = FALSE}
# Save input R data frame as a SyncroSim Datasheet
saveDatasheet(ssimObject = myScenario, data = myInputDataframe,
              name = "helloworldSpatial_InputDatasheet")
```

**RunControl Datasheet**

The `RunControl` Datasheet sets the number of iterations and the minimum and maximum time steps for our model. We'll add this information to an R data frame as well and then add it to the Run Control Datasheet using `addRow()`. We need to specify data for the following 4 columns:

* `MinimumIteration` : starting value of iterations (default=1).
* `MaximumIteration` : total number of iterations to run the model for.
* `MinimumTimestep` : the starting time point of the simulation.
* `MaximumTimestep` : the end time point of the simulation.

```{r modify run control}
# Assign run control Datasheet to a new data frame variable
runSettings <- datasheet(myScenario, name = "helloworldSpatial_RunControl")

# Check the columns of the run control data frame
str(runSettings)

# Create run control data and add it to the run control data frame
runSettingsRow <- data.frame(MinimumIteration = 1,
                             MaximumIteration = 5,
                             MinimumTimestep = 1,
                             MaximumTimestep = 10)
runSettings <- addRow(runSettings, runSettingsRow)

# Check values
runSettings

# Save run control R data frame as a SyncroSim Datasheet
saveDatasheet(ssimObject = myScenario, data = runSettings,
              name = "helloworldSpatial_RunControl")
```

**Pipeline Datasheet**

The `helloworldSpatial` package also makes use of pipelines to link the output of one model to the input of a second model. To learn more about pipelines, see the [`rsyncrosim`: introduction to pipelines](https://syncrosim.github.io/rsyncrosim/rsyncrosim_vignette_pipelines.html) vignette and the SyncroSim <a href="https://docs.syncrosim.com/how_to_guides/package_create_pipelines.html" target="_blank">Enhancing a Package: Linking Models</a> tutorial.

To implement pipelines in our package, we need to specify the order in which to run our two models by editing the `Pipeline` Datasheet. The `Pipeline` Datasheet is part of the built-in SyncroSim core. From viewing the structure of the `Pipeline` Datasheet we know that the `StageNameID` is a factor with 2 levels: "First Model" and "Second Model". We will set the data for this Datasheet such that "First Model" is run first, and then "Second Model".

```{r modify pipeline}
# Assign Pipeline Datasheet to a new data frame variable
myPipelineDataframe <- datasheet(myScenario, name = "core_Pipeline")

# Check the columns of the Pipeline data frame
str(myPipelineDataframe)

# Create Pipeline data and add it to the Pipeline data frame
myPipelineRow <- data.frame(StageNameID = c("First Model", "Second Model"),
                            RunOrder = c(1, 2))

myPipelineDataframe <- addRow(myPipelineDataframe, myPipelineRow)

# Check values
myPipelineDataframe

# Save Pipeline R data frame as a SyncroSim Datasheet
saveDatasheet(ssimObject = myScenario, data = myPipelineDataframe,
              name = "core_Pipeline")
```


## Run Scenarios

### Setting run parameters with `run()`

We will now run our Scenario using the `run()` function in `rsyncrosim`. If we have a large model and we want to parallelize the run using multiprocessing, we can set the `jobs` argument to be a value greater than 1.

```{r run first Scenario, warning = FALSE}
# Run the first Scenario we created
myResultScenario <- run(myScenario, jobs = 5)
```

## View results


### Viewing non-spatial results with `datasheet()`

The next step is to view the result Scenarios. For each step in the pipeline, We can load the result tables using the `datasheet()` function.


```{r view results datasheets, warning = FALSE, eval = FALSE, results = FALSE}
# Results of first Scenario, first model of first model in Pipeline
resultsSummary <- datasheet(myResultScenario,
                            name = "helloworldSpatial_IntermediateDatasheet")

# View results table of first model in Pipeline
head(resultsSummary)
```

```{r resultsSummary cleaned, echo = FALSE}
# Results of first Scenario, first model of first model in Pipeline
resultsSummary <- datasheet(myResultScenario,
                            name = "helloworldSpatial_IntermediateDatasheet")

resultsSummary$OutputRasterFile <- sub(
  ".*\\\\", "", resultsSummary$OutputRasterFile
  )

head(resultsSummary)
```

```{r view results summary 2, warning = FALSE}
# Results of first Scenario, second model in Pipeline
resultsSummary2 <- datasheet(myResultScenario,
                             name = "helloworldSpatial_OutputDatasheet")

# View results table of second model in Pipeline
head(resultsSummary2)
```

From viewing these Datasheets, we can see that the spatial output is contained within the `IntermediateDatasheet`, in the column called `OutputRasterFile`.


### Viewing spatial results with `datasheetRaster()`

For spatial results, we want to load the results as raster images. To do this, we will use the `datasheetRaster()` function from `rsyncrosim`. The first argument is the result Scenario object. Next, we specify the name of the Datasheet containing raster images using the `datasheet` argument, amd the column pertaining to the raster images using the `column` argument. The results contain many raster images, since we have a raster for each combination of iteration and time step. We can use the `iteration` and `timestep` arguments to specify a single raster image or a subset of raster images we want to view. 

```{r view results raster, warning = FALSE}
# Load raster files for first result Scenario with time step and iteration
rasterMaps <- datasheetRaster(
  myResultScenario,
  datasheet = "helloworldSpatial_IntermediateDatasheet",
  column = "OutputRasterFile",
  iteration = 1,
  timestep = 5
  )

# View results
rasterMaps
plot(rasterMaps[[1]])
```
