---
title: "Introduction to `rsyncrosim`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Introduction to `rsyncrosim`}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
params:
  EVAL: !r identical(Sys.getenv("NOT_CRAN"), "true")
---

This vignette will cover the basics of using the `rsyncrosim` package within the <a href="https://syncrosim.com/" target="_blank">SyncroSim</a> software framework.


## Overview of SyncroSim


<a href="https://syncrosim.com/" target="_blank">SyncroSim</a> is a software platform that helps you turn your *data* into *forecasts*. At the core of SyncroSim is an engine that automatically structures your existing data, regardless of its original format. SyncroSim transforms this structured data into forecasts by running it through a Pipeline of calculations (i.e. a suite of *models*). Finally, SyncroSim  provides a rich interface to interact with your data and models, allowing you to explore and track the consequences of alternative "what-if" forecasting Scenarios. Within this software framework is the ability to use and create <a href="https://docs.syncrosim.com/how_to_guides/package_overview.html" target="_blank">SyncroSim packages</a>.  

For more details consult the SyncroSim <a href="https://docs.syncrosim.com/" target="_blank">online documentation</a>.


## Overview of rsyncrosim


`rsyncrosim` is an R package designed to facilitate the development of modeling workflows for the <a href="https://syncrosim.com/" target="_blank">SyncroSim</a> software framework. Using the `rsyncrosim` interface, simulation models can be added and run through SyncroSim to transform Scenario-based datasets into model forecasts. This R package takes advantage of general features of SyncroSim, such as defining Scenarios with spatial or non-spatial inputs, running Monte Carlo simulations, and summarizing model outputs. `rsyncrosim` requires SyncroSim 2.2.13 or higher.

For more details consult the `rsyncrosim` <a href="https://cran.r-project.org/web/packages/rsyncrosim/index.html" target="_blank">CRAN documentation</a>.

## SyncroSim Package: `helloworldTime`


To demonstrate the utility of the `rsyncrosim` interface, we will be using the <a href="https://github.com/ApexRMS/helloworldTime" target="_blank">helloworldTime</a> SyncroSim package. `helloworldTime` was designed to be a simple package to introduce timesteps to SyncroSim modeling workflows.

The package takes from the user 2 inputs, *m* and *b*, representing a slope and an intercept value. It then runs these input values through a linear model, *y=mt+b*, where *t* is *time*, and returns the *y* value as output.


![Infographic of helloworldTime package](./infographic-basic.png){width=600px}

For more details on the different features of the `helloworldTime` SyncroSim package, consult the SyncroSim <a href="https://docs.syncrosim.com/how_to_guides/package_create_timesteps.html" target="_blank">Enhancing a Package tutorial</a>.


## Setup


### Install SyncroSim

Before using `rsyncrosim` you will first need to <a href="https://syncrosim.com/download/" target="_blank">download and install</a> the SyncroSim software. Versions of SyncroSim exist for both Windows and Linux.

### Installing and loading R packages

You will need to install the `rsyncrosim` R package, either using <a href="https://cran.r-project.org/" target="_blank">CRAN</a> or from the `rsyncrosim` <a href="https://github.com/syncrosim/rsyncrosim/releases/" target="_blank">GitHub repository</a>. Versions of `rsyncrosim` are available for both Windows and Linux.

In a new R script, load the `rsyncrosim` package.

```{r load packages}
# Load R package for working with SyncroSim
library(rsyncrosim)
```

### Installing SyncroSim packages using `addPackage()`

Check if the <a href="https://github.com/ApexRMS/helloworldTime" target="_blank">helloworldTime</a> package is already installed. Use the `package()` function from `rsyncrosim` to first get a list of all currently installed packages in SyncroSim.

```{r delete SyncroSim packages, echo = FALSE, results = FALSE, message = FALSE}
installedPackages <- package()
if (is.element("demosales", installedPackages$name)) removePackage("demosales", force = TRUE)
if (is.element("dgsim", installedPackages$name)) removePackage("dgsim", force = TRUE)
if (is.element("epi", installedPackages$name)) removePackage("epi", force = TRUE)
if (is.element("helloworld", installedPackages$name)) removePackage("helloworld", force = TRUE)
if (is.element("helloworldEnhanced", installedPackages$name)) removePackage("helloworldEnhanced", force = TRUE)
if (is.element("helloworldTime", installedPackages$name)) removePackage("helloworldTime", force = TRUE)
if (is.element("helloworldUncertainty", installedPackages$name)) removePackage("helloworldUncertainty", force = TRUE)
if (is.element("helloworldPipeline", installedPackages$name)) removePackage("helloworldPipeline", force = TRUE)
if (is.element("helloworldSpatial", installedPackages$name)) removePackage("helloworldSpatial", force = TRUE)
if (is.element("landfirevegmodels", installedPackages$name)) removePackage("landfirevegmodels", force = TRUE)
if (is.element("stsim", installedPackages$name)) removePackage("stsim", force = TRUE)
if (is.element("stsimsf", installedPackages$name)) removePackage("stsimsf", force = TRUE)
```


```{r check packages 1, warning = FALSE}
# Get list of installed packages
package()
```

Currently we do not have the `helloworldTime` package installed! Install `helloworldTime` using the `rynscrosim` function `addPackage()`. This function takes a package name as input and then queries the SyncroSim package server for the specified package.

```{r add package from server, warning = FALSE}
# Install helloworldTime
addPackage("helloworldTime")
```

To install the package from a `.ssimpkg` file on your local computer rather than installing directly from the server, you can use the `addPackage()` function with the `filepath` argument set to `TRUE`. Instead of using the package name as the argument, the file path to the `.ssimpkg` is used.

```{r add package from path not run, warning = FALSE, eval = FALSE}
# Install helloworldTime using file path to ssimpkg file
addPackage("path/to/helloworldTime.ssimpkg")
```

Now `helloworldTime` should be included in the package list:

```{r check packages 2, warning = FALSE}
# Get list of installed packages
package()
```


*Note:* you can also update installed packages using the `updatePackage()` function or delete installed packages using the `removePackage()` function in `rsyncrosim`.

### Connecting R to SyncroSim using `session()`

The final step in setting up the R environment for the `rsyncrosim` workflow is to create a SyncroSim Session object in R that provides the connection to your installed copy of the SyncroSim software. A new Session is created using the `session()` function, in which the first argument is a path to the folder on your computer where SyncroSim has been installed. If the first argument is left blank, then the default install folder is used (Windows only).

```{r load session not run, warning = FALSE, eval = FALSE}
mySession <- session("path/to/install_folder")      # Create a Session based SyncroSim install folder
mySession <- session()                              # Using default install folder (Windows only)
mySession                                           # Displays the Session object
```

```{r load session run, warning = FALSE, echo = FALSE}
# Results of this code shown for above
mySession <- session()                              # Using default install folder (Windows only)
mySession                                           # Displays the Session object
```

You can check to see which version of SyncroSim your R script is connected to by running the `version()` function.

```{r check version, warning = FALSE}
version(mySession)
```


## Create a modeling workflow


When creating a new modeling workflow from scratch, we need to create objects of the following scopes:

* <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Library</a>
* <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Projects</a>
* <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Scenarios</a>

These objects are hierarchical, such that a Library can contain many Projects, and each Project can contain many Scenarios. All parameters or configurations set in a Library are inherited by all Projects within the Library, and all parameters or configurations set in a Project are inherited by all Scenarios within that Project. See below for further information on these model objects.

### Create a new Library using `ssimLibrary()`

A SyncroSim <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Library</a> is a file (with `.ssim` extension) that stores all of your model inputs and outputs. The format of each SyncroSim Library is unique to the SyncroSim Package with which it is associated. We use the `ssimLibrary()` function to create a new SsimLibrary object in R that is connected (through your Session) to a SyncroSim Library file. We can also use the `ssimLibrary()` function to open an existing Library. Note that if you want to create a new Library file with an existing Library name rather than opening the existing Library, you can use `overwrite=TRUE` for the `ssimLibrary()` function.

```{r create Library, warning = FALSE, eval = FALSE, results = FALSE}
# Create a new Library
myLibrary <- ssimLibrary(name = "helloworldLibrary.ssim",
                         session = mySession,
                         package = "helloworldTime",
                         overwrite = TRUE)

# Check Library information
myLibrary
```

```{r create Library output, warning = FALSE, echo = FALSE}
# Create a new Library
myLibrary <- ssimLibrary(name = "helloworldLibrary.ssim",
                         session = mySession,
                         package = "helloworldTime",
                         overwrite = TRUE)

# Create output
myLibraryOutput <- myLibrary
myLibraryOutput@filepath <- "path/to/helloworldLibrary.ssim"

# Print output
myLibraryOutput
```


### Open a Project using `project()`

Each SyncroSim Library contains one or more SyncroSim <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Projects</a>, each represented by a Project object in R. Projects typically store model inputs that are common to all your Scenarios. In most situations you will need only a single Project for your Library; by default each new Library starts with a single Project named "Definitions" (with a unique `projectId`= 1). The `project()` function is used to both create and retrieve Projects. Note that the `ssimObject` here can be the name of a Library or Scenario.

```{r open project, warning = FALSE, eval = FALSE, results = FALSE}
# Open existing Project
myProject = project(ssimObject = myLibrary, project = "Definitions")  # Using name for Project
myProject = project(ssimObject = myLibrary, project = 1)              # Using projectId for Project

# Check Project information
myProject
```

```{r open project output, warning = FALSE, echo = FALSE}
# Open existing Project
myProject = project(ssimObject = myLibrary, project = "Definitions")  # Using name for Project

# Create output
myProjectOutput <- myProject
myProjectOutput@filepath <- "path/to/helloworldLibrary.ssim"

# Print output
myProjectOutput
```


### Create a new Scenario using `scenario()`

Finally, each SyncroSim Project contains one or more <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Scenarios</a>, each represented by a Scenario object in R. Scenarios store the specific model inputs and outputs associated with each model run in SyncroSim. Scenarios can contain multiple models connected by a series of Pipelines, such that the output of one model becomes the input of the next. Each Scenario can be identified by its unique `scenarioId`. The `scenario()` function is used to both create and retrieve Scenarios. Note that the `ssimObject` here can be the name of a Library or a Project.

```{r create Scenario, warning = FALSE, eval = FALSE, results = FALSE}
# Create a new Scenario (associated with the default Project)
myScenario = scenario(ssimObject = myProject, scenario = "My first scenario")

# Check Scenario information
myScenario
```

```{r create Scenario output, warning = FALSE, echo = FALSE}
# Create a new Scenario (associated with the default Project)
myScenario = scenario(ssimObject = myProject, scenario = "My first scenario")

# Create output
myScenarioOutput <- myScenario
myScenarioOutput@filepath <- "path/to/helloworldLibrary.ssim"

# Print output
myScenarioOutput
```


### View model inputs using `datasheet()`
  
Each SyncroSim Library contains multiple SyncroSim <a href="https://docs.syncrosim.com/how_to_guides/properties_overview.html" target="_blank">Datasheets</a>. A SyncroSim Datasheet is simply a table of data stored in the Library. Datasheets each have a *scope*: either <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Library</a>, 
<a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Project</a>, or 
<a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Scenario</a>. We can view Datasheets of varying scopes using the `datasheet()` function from `rsyncrosim`.

```{r view datasheet list, warning = FALSE}
# View all Datasheets associated with a Library, Project, or Scenario
datasheet(myScenario)
```

To view a specific Datasheet rather than just a data frame of available Datasheets, set the `name` parameter in the `datasheet()` function to the name of the Datasheet you want to view. The general syntax of the name is: "\<name of package\>_\<name of Datasheet\>". From the list of Datasheets above, we can see that there are 3 Datasheets specific to the `helloworldTime` package.

```{r view specific datasheet, warning = FALSE}
# View the input Datasheet for the Scenario
datasheet(myScenario, name = "helloworldTime_InputDatasheet")
```

Here, we are viewing a SyncroSim Datasheet as an R data frame. Although both SyncroSim Datasheets and R data frames are both represented as tables of data with predefined columns and an unlimited number of rows, the underlying structure of these tables differ.

### Configure model inputs using `datasheet()` and `addRow()`

Currently our input Scenario Datasheets are empty! We need to add some values to our input Datasheet (`InputDatasheet`) so we can run our model. First, assign the input Datasheet to a new data frame variable.

```{r assign input data, warning = FALSE}
# Assign input Datasheet to a new data frame variable
myInputDataframe <- datasheet(myScenario,
                              name = "helloworldTime_InputDatasheet")
```

Now, check the columns that need input values and the type of values these columns require (e.g. string, numeric, logical) using the `str()` base R function.

```{r check input data, warning = FALSE}
# Check the columns of the input data frame
str(myInputDataframe)
```

The input Datasheet requires 2 values:

* `m` : the slope of the linear equation.
* `b` : the intercept of the linear equation.

We can add these values to a new data frame, then use the `addRow()` function from `rsyncrosim` to update the input Datasheet. The `addRow()` function takes the `targetDataframe` as the first value (in this case, our input Datasheet that we want to update), and the new rows to append to this data frame as the second value.

```{r add input data not run, warning = FALSE}
# Create input data and add it to the input data frame
myInputRow <- data.frame(m = 2, b = 10)
myInputDataframe <- addRow(myInputDataframe, myInputRow)

# Check values
myInputDataframe
```

### Saving modifications to Datasheets using `saveDatasheet()`

Now that we have added values to the input Datasheet, we will save our updated Datasheet to the Library, Project, and/or Scenario using the `saveDatasheet()` function.

```{r save input data, warning = FALSE}
# Save input R data frame as a SyncroSim Datasheet
saveDatasheet(ssimObject = myScenario, data = myInputDataframe,
              name = "helloworldTime_InputDatasheet")
```

### Configuring the `RunControl` Datasheet

There is one other Datasheet that we need to configure for our package to run. The `RunControl` Datasheet provides information about how many time steps to use in the model. Here, we set the minimum and maximum time steps for our model. We'll add this information to an R data frame and then add it to the Run Control Datasheet using `addRow()`. We need to specify data for the following 2 columns:

* `MinimumTimestep` : the starting time point of the simulation.
* `MaximumTimestep` : the end time point of the simulation.

```{r modify run control}
# Assign run control Datasheet to a new data frame variable
runSettings <- datasheet(myScenario, name = "helloworldTime_RunControl")

# Check the columns of the run control data frame
str(runSettings)

# Create run control data and add it to the run control data frame
runSettingsRow <- data.frame(MinimumTimestep = 1,
                             MaximumTimestep = 10)
runSettings <- addRow(runSettings, runSettingsRow)

# Check values
runSettings

# Save run control R data frame as a SyncroSim Datasheet
saveDatasheet(ssimObject = myScenario, data = runSettings,
              name = "helloworldTime_RunControl")
```


## Edit Scenarios


You may want to test multiple alternative Scenarios that have slightly different inputs. To save time, you can copy a Scenario that you've already made, give it a different name, and modify the inputs. To copy a completed Scenario, use the `scenario()` function with the `sourceScenario` argument set to the name of the Scenario you want to copy.

```{r create new Scenario from source, warning = FALSE}
# Check which Scenarios you currently have in your Library
scenario(myLibrary)['name']

# Create a new Scenario based off an old Scenario
myNewScenario <- scenario(ssimObject = myProject,
                          scenario = "My second scenario",
                          sourceScenario = myScenario)

# Make sure this new Scenario has been added to the Library
scenario(myLibrary)['name']
```


To edit the new Scenario, we must first load the Datasheet and assign it to a new variable using the `datasheet()` function. We will set the `empty` argument to `TRUE` so that instead of getting the values from the old Scenario, we can add a data frame of new values.

```{r load input data from new Scenario, warning = FALSE}
# Load empty input Datasheets as an R data frame
myNewInputDataframe <- datasheet(myNewScenario,
                                 name = "helloworldTime_InputDatasheet",
                                 empty=TRUE)

# Check that we have an empty data frame
str(myNewInputDataframe)
```

Now, all we need to do is add our data frame of values the same way we did before, using the `addRow()` function.

```{r edit input data for new Scenario, warning = FALSE}
# Create input data and add it to the input data frame
newInputRow <- data.frame(m = 4, b = 10)
myNewInputDataframe <- addRow(myNewInputDataframe, newInputRow)

# View the new inputs
myNewInputDataframe
```

Finally, we will save the updated data frame to a SyncroSim Datasheet using `saveDatasheet()`.

```{r save new Scenario, warning = FALSE}
# Save R data frame to a SyncroSim Datasheet
saveDatasheet(ssimObject = myNewScenario, data = myNewInputDataframe,
              name = "helloworldTime_InputDatasheet")
```

## Run Scenarios

### Setting run parameters with `run()`

We will now run our Scenarios using the `run()` function in `rsyncrosim`, starting with the first Scenario we created ("My first scenario").

```{r run first Scenario, warning = FALSE}
# Run the first Scenario we created
myResultScenario <- run(myScenario)
```

We can also tell SyncroSim to run all the Scenarios in our Project at once. Instead of passing a single Scenario to the `run()` function, we will tell `run()` which Project to use and include a vector of Scenarios.

```{r run multiple Scenarios, warning = FALSE}
# Run all Scenarios
myResultScenarioAll <- run(myProject,
                           scenario = c("My first scenario",
                                        "My second scenario"))
```

### Checking the run log with `runLog()`

For more information use the `runLog()` function, in which the only argument is the result Scenario variable.

```{r get run log, warning = FALSE}
# Get run details for the first result Scenario
runLog(myResultScenario)
```


## View results


### Viewing results with `datasheet()`

The next step is to view the result Scenarios. We can load the result tables using the `datasheet()` function.


```{r view results datasheets, warning = FALSE}
# Results of first Scenario
resultsSummary <- datasheet(myResultScenario,
                            name = "helloworldTime_OutputDatasheet")

# View results table
head(resultsSummary)
```

### Identifying the parent Scenario of a result Scenario using `parentId()`

If you have many alternative Scenarios and many results Scenarios, you can always find the parent Scenario that led to a result Scenario using the `rsyncrosim` function `parentId()`.

```{r get parent ID, warning = FALSE}
parentId(myResultScenarioAll[[1]])
parentId(myResultScenarioAll[[2]])
```


## Access model metadata


### Getting Library information using `info()`

Retrieve Library information:
  
```{r Library metadata, warning = FALSE, eval = FALSE}
info(myLibrary)
```

```{r, echo = FALSE}
libInfo <- info(myLibrary)
libInfo$value[10:13] <- sub(
  ".*\\\\", "", libInfo$value[10:13]
  )
libInfo
```


### Getting information of any ssimObject

The following functions can be used to get useful information about a Library, Project, or Scenario:

* `name()` : used to retrieve or assign a name
* `owner()` : used to retrieve or assign an owner
* `dateModified()` : used to retrieve the date when the last changes were made
* `readOnly()` : used to retrieve or assign the read-only status
* `filepath()` : retrieve local file path
* `description()` : retrieve or add a description

You can also find identification numbers of Projects or Scenarios using the following functions:

* `projectID()` : used to retrieve the Project identification number
* `scenarioID()` : used to retrieve the Scenario identification number

## Backup your Library

Once you have finished running your models, you may want to backup the inputs and results into a zipped .backup subfolder. First, we want to modify the Library Backup Datasheet to allow the backup of model outputs. Since this Datasheet is part of the built-in SyncroSim core, the name of the Datasheet has the prefix "core".

```{r backup Library, warning = FALSE}
# Get the current values for the Library's Backup Datasheet
sheetData <- datasheet(myLibrary, name = "core_Backup")   

# View current values for the Library's Backup Datasheet
sheetData

# Add output to the Library's Backup Datasheet and save
sheetData$IncludeOutput <- TRUE 
saveDatasheet(myLibrary, data = sheetData, name = "core_Backup")

# Check to make sure IncludeOutput is now TRUE
datasheet(myLibrary, "core_Backup")
```

Now, you can use the `backup()` function from `rsyncrosim` to backup a Library, Project, or Scenario.

```{r, warning = FALSE}
backup(myLibrary)
```
