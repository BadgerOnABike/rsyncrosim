---
title: "`rsyncrosim`: introduction to `ST-Sim`"
author: "Colin Daniel, ApexRMS"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
 %\VignetteIndexEntry{Introduction to `ST-Sim` in `rsyncrosim`}
 %\VignetteEngine{knitr::rmarkdown}
 %\usepackage[utf8]{inputenc}
params:
  EVAL: !r identical(Sys.getenv("NOT_CRAN"), "true")
---
  
```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(collapse = T, comment = "#>", eval = params$EVAL)
options(tibble.print_min = 4, tibble.print_max = 4)
library(rsyncrosim)
library(raster)
```
```{r, echo = FALSE, message = FALSE}
mySession <- session() # start default session
addPackage("stsim", mySession)
temp_dir <- tempdir()
libraryName <- file.path(temp_dir,"demoLib.ssim") 
myLibrary <- ssimLibrary(name = libraryName, session = mySession, overwrite = T)
```
This vignette will cover how to develop and run spatially-explicit, stochastic state-and-transition simulation models of landscape change using the `rsyncrosim` package within the [SyncroSim](https://syncrosim.com/) software framework. For an overview of [SyncroSim](https://syncrosim.com/) and `rsyncrosim`, as well as a basic usage tutorial for 'rsyncrosim`, see the [Introduction to](https://syncrosim.github.io/rsyncrosim/articles/a01_rsyncrosim_vignette_basic.html#setup-1) 'rsyncrosim` vignette. To learn how to use iterations in the `rsyncrosim` interface, see the `rsyncrosim`: [introduction to uncertainty vignette](https://syncrosim.github.io/rsyncrosim/articles/a02_rsyncrosim_vignette_uncertainty.html). To learn how to link models using pipelines in the `rsyncrosim` interface, see the `rsyncrosim`: [introduction to pipelines](https://syncrosim.github.io/rsyncrosim/articles/a03_rsyncrosim_vignette_pipelines.html) vignette. To learn how to incorporate spatial data into SyncroSim models using the `rsyncrosim` interface, see the `rsyncrosim`:[introduction to spatial data](https://syncrosim.github.io/rsyncrosim/articles/a04_rsyncrosim_vignette_spatial.html) vignette.  

the *stsim* [SyncroSim Package](https://docs.syncrosim.com/how_to_guides/package_overview.html). *stsim* is a SyncroSim Package that lets you develop and run spatially-explicit, stochastic state-and-transition simulation models of landscape change. For more details on *stsim*, consult the [ST-Sim online documentation](https://docs.stsim.net/).

## SyncroSim Package: 'stsim'

To demonstrate how to create and run spatially-explicit, stochastic state-and-transition simulation models of landscape change, we will be using the [stsim](https://github.com/ApexRMS/stsim) SyncroSim package.

## Setup

### Install SyncroSim

Before using `rsyncrosim` you will first need to [download and install](https://syncrosim.com/download/) the SyncroSim software. Versions of SyncroSim exist for both Windows and Linux.

### Installing and loading R packages

You will need to install the `rsyncrosim` R package, either using [CRAN](https://cran.r-project.org/) or from the `rsyncrosim` [GitHub repository](https://github.com/syncrosim/rsyncrosim/releases/). Versions of `rsyncrosim` are available for both Windows and Linux. You may need to install the `raster` and `rgdal` packages from CRAN as well.

In a new R script, load the necessary packages. This includes the `rsyncrosim` and `raster` R packages. 

```{r load packages}
# Load R packages
library(rsyncrosim)  # package for working with SyncroSim
library(raster)      # package for working with raster data
```

### Installing SyncroSim packages using `addPackage()`

```{r delete SyncroSim packages, echo = FALSE, results = FALSE, message = FALSE}
installedPackages <- package()
if (is.element("demosales", installedPackages$name)) removePackage("demosales", force = TRUE)
if (is.element("dgsim", installedPackages$name)) removePackage("dgsim", force = TRUE)
if (is.element("epi", installedPackages$name)) removePackage("epi", force = TRUE)
if (is.element("helloworld", installedPackages$name)) removePackage("helloworld", force = TRUE)
if (is.element("helloworldEnhanced", installedPackages$name)) removePackage("helloworldEnhanced", force = TRUE)
if (is.element("helloworldTime", installedPackages$name)) removePackage("helloworldTime", force = TRUE)
if (is.element("helloworldUncertainty", installedPackages$name)) removePackage("helloworldUncertainty", force = TRUE)
if (is.element("helloworldPipeline", installedPackages$name)) removePackage("helloworldPipeline", force = TRUE)
if (is.element("helloworldSpatial", installedPackages$name)) removePackage("helloworldSpatial", force = TRUE)
if (is.element("landfirevegmodels", installedPackages$name)) removePackage("landfirevegmodels", force = TRUE)
if (is.element("stsim", installedPackages$name)) removePackage("stsim", force = TRUE)
if (is.element("stsimsf", installedPackages$name)) removePackage("stsimsf", force = TRUE)
```

Install `stsim` using the `rsyncrosim` function `addPackage()`. This function takes a package name as input and then queries the SyncroSim package server for the specified package.

```{r add package from server, warning = FALSE}
# Install stsim
addPackage("stsim")
```

`stsim` should now be included in the package list returned by the `package()` function in `rsyncrosim`:

```{r check packages 2, warning = FALSE}
# Get list of installed packages
package()
```

### Connecting R to SyncroSim using `session()`

Finish setting up the R environment for the `rsyncrosim` workflow by creating a SyncroSim Session object. Use the `session()` function to connect R to your installed copy of the SyncroSim software.

```{r load session not run, warning = FALSE, eval = FALSE}
mySession <- session("path/to/install_folder")      # Create a Session based SyncroSim install folder
mySession <- session()                              # Using default install folder (Windows only)
mySession                                           # Displays the Session object
```

```{r load session run, warning = FALSE, echo = FALSE}
# Results of this code shown for above
mySession <- session()                              # Using default install folder (Windows only)
mySession                                           # Displays the Session object
```

Use the `version()` function to ensure you are using the latest version of SyncroSim.


```{r check version, warning = FALSE}
version(mySession)
```


## Create a modeling workflow


When creating a new modeling workflow from scratch, we need to create objects of the following scopes:

* <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Library</a>
* <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Projects</a>
* <a href="https://docs.syncrosim.com/how_to_guides/library_overview.html" target="_blank">Scenarios</a>

For more information on these scopes, see the [Introduction to `rsyncrosim`](https://syncrosim.github.io/rsyncrosim/rsyncrosim_vignette_basic.html) vignette.

### Set up Library, Project, and Scenario

```{r create Library, warning = FALSE}
# Create a new Library
myLibrary <- ssimLibrary(name = "stsimLibrary.ssim",
                         session = mySession,
                         package = "stsim",
                         overwrite = TRUE)

# Open the default Project
myProject <- project(ssimObject = myLibrary, project = "Definitions")

# Create a new Scenario (associated with the default Project)
myScenario <- scenario(ssimObject = myProject, scenario = "My spatial scenario")
```

### View model inputs using `datasheet()`

View the Datasheets associated with your new Scenario using the `datasheet()` function from `rsyncrosim`.

```{r view datasheet list, warning = FALSE, eval = FALSE}
# View all Datasheets associated with a Library, Project, or Scenario
datasheet(myScenario)
```

From this list of Datasheets, we can see that there are 82 Datasheets specific to the `stsim` package, including a number of Initial Conditions Datasheets, Output Datasheets, and a Run Control Datasheet.

### Configure model inputs using `datasheet()` and `addRow()`

SC note: I think this paragraph below should be replaced by the one below the Project Definitions heading. 

Currently our input Scenario Datasheets are empty! We need to add some values to our input Datasheet (`InputDatasheet`) and run control Datasheet (`RunControl`) so we can run our model. Since this package also uses pipelines, we also need to add some information to the core `Pipeline` Datasheet to specify which models are run in which order. For more information on using pipelines, see the [`rsyncrosim`: introduction to pipelines](https://syncrosim.github.io/rsyncrosim/rsyncrosim_vignette_pipelines.html) vignette and the SyncroSim <a href="https://docs.syncrosim.com/how_to_guides/package_create_pipelines.html" target="_blank">Enhancing a Package: Linking Models</a> tutorial.



**Input Datasheet**

SC Note: what is the stsim equivalent of Input Datasheets?




Finally, for this tutorial, we need to retrieve the sample raster files (in GeoTIFF format) provided with the `rsyncrosim` package.

```{r}
stratumTif <- system.file("extdata", "initial-stratum.tif", 
                          package = "rsyncrosim")
sclassTif <- system.file("extdata", "initial-sclass.tif", 
                         package = "rsyncrosim")
ageTif <- system.file("extdata", "initial-age.tif", 
                      package = "rsyncrosim")
```



### Project Definitions

In order to run a model in SyncroSim, we first need to setup all of the required model inputs. Inputs for `stsim` come in two forms: Scenario inputs (which *can* vary by Scenario) and Project inputs (which *must* be fixed across all Scenarios). In general most inputs are Scenario inputs; Project inputs are typically reserved for values that must be shared by all Scenarios (e.g. constants, shared lookup values).

Let's begin by configuring our Project inputs. All inputs in SyncroSim are stored in Datasheets. We say that inputs associated with a Project are *project-scoped Datasheets*. For example, in *stsim* there is a project-scoped Datasheet called *Terminology* specifying terms used across all Scenarios. We will use the `datasheet` function to retrieve the current values for this Datasheet, as currently stored in the SyncroSim Library file.

```{r}
# Returns a dataframe of the Terminology Datasheet
sheetData <- datasheet(myProject, name="stsim_Terminology")
str(sheetData)
```

We can now change the terminology of the `StateLabelX` and `AmountUnits` columns in our Datasheet, and then save those changes back to the SyncroSim Library file.

```{r}
# Edit the dataframe values
sheetData$AmountUnits <- "Hectares"
sheetData$StateLabelX <- "Forest Type"

# Saves the edits back to the Library file
saveDatasheet(myProject, sheetData, "stsim_Terminology") 
```

Similarly we can edit other Project-scoped Datasheets for *stsim*. 

**Stratum**:  Primary Strata in the model
```{r}
# Retrieves an empty copy of the Datasheet
sheetData <- datasheet(myProject, "stsim_Stratum", empty = TRUE)

# Helper function in rsyncrosim to add rows to dataframes
sheetData <- addRow(sheetData, "Entire Forest")

# Save edits to file
saveDatasheet(myProject, sheetData, "stsim_Stratum", force = TRUE)
```

**StateLabelX**: First dimension of labels for State Classes
```{r}
forestTypes <- c("Coniferous", "Deciduous", "Mixed")
saveDatasheet(myProject, data.frame(Name = forestTypes), "stsim_StateLabelX", force = TRUE)
```

**StateLabelY**: Second dimension of labels for State Classes
```{r}
saveDatasheet(myProject, data.frame(Name = c("All")), "stsim_StateLabelY", force = TRUE)
```

**State Classes**: Combines **StateLabelX** and **StateLabelY**; assigns each one a unique name and ID
```{r}
stateClasses <- data.frame(Name = forestTypes)
stateClasses$StateLabelXID <- stateClasses$Name
stateClasses$StateLabelYID <- "All"
stateClasses$ID <- c(1, 2, 3)
saveDatasheet(myProject, stateClasses, "stsim_StateClass", force = TRUE)
```

**Transition Types**: Defines the types of transition in our model; assigns each one a unique name and ID
```{r}
transitionTypes <- data.frame(Name = c("Fire", "Harvest", "Succession"), ID = c(1, 2, 3))
saveDatasheet(myProject, transitionTypes, "stsim_TransitionType", force = TRUE)
```

**Transition Groups**: Makes the Groups identical to the Types
```{r}
transitionGroups <- data.frame(Name = c("Fire", "Harvest", "Succession"))
saveDatasheet(myProject, transitionGroups, "TransitionGroup", force = T)
```

**Transition Types by Groups**: Assigns each Type to its Group
```{r}
transitionTypesGroups <- data.frame(TransitionTypeID = transitionTypes$Name,
                                    TransitionGroupID = transitionGroups$Name)
saveDatasheet(myProject, transitionTypesGroups, "TransitionTypeGroup", force = T)
```

**Ages** defines the basic parameters to control the age reporting in the model
```{r}
ageFrequency <- 1
ageMax <- 101
ageGroups <- c(20, 40, 60, 80, 100)

saveDatasheet(myProject, data.frame(Frequency = ageFrequency, MaximumAge = ageMax),
              "AgeType", force = TRUE)
saveDatasheet(myProject, data.frame(MaximumAge = ageGroups), "stsim_AgeGroup", force = TRUE)
```

### Scenario Inputs

Now that we have defined all our Project level definitions we can move on to specifying scenario-specific model inputs. We begin by using the `scenario` function to create a new Scenario in our Project.

```{r}
myScenario <- scenario(myProject, "No Harvest")
```

Once again we can use the `datasheet` function (with `summary=TRUE`) to display all the scenario-scoped Datasheets.

```{r, eval = FALSE}
# Subset the list to show only Scenario Datasheets
subset(datasheet(myScenario, summary = TRUE), scope == "scenario")
```

We can now use the `datasheet` function to retrieve, one at a time, each of our Scenario-scoped Datasheets from our Library.

**Run Control** defines the length of the run and whether or not it is a spatial run (requires spatial inputs to be set, see below). Here we make the run spatial:
```{r}
# Run simulation for 7 realizations and 10 timesteps
sheetName <- "stsim_RunControl"
sheetData <- data.frame(MaximumIteration = 7,
                        MinimumTimestep = 0,
                        MaximumTimestep = 10,
                        isSpatial = TRUE)
saveDatasheet(myScenario, sheetData, sheetName)
```

**Deterministic Transitions** first define transitions that take place in the absence of probabilistic transitions. Here we also set the age boundaries for each State Class:
```{r}
# Add all the deterministic transitions
sheetName <- "stsim_DeterministicTransition"
sheetData <- datasheet(myScenario, sheetName, optional = T, empty = T)
sheetData <- addRow(sheetData, data.frame(StateClassIDSource = "Coniferous",
                                          StateClassIDDest = "Coniferous",
                                          AgeMin = 21,
                                          Location = "C1"))
sheetData <- addRow(sheetData, data.frame(StateClassIDSource = "Deciduous",
                                          StateClassIDDest = "Deciduous",
                                          Location = "A1"))
sheetData <- addRow(sheetData, data.frame(StateClassIDSource = "Mixed",
                                          StateClassIDDest = "Mixed",
                                          AgeMin = 11,
                                          Location = "B1"))
saveDatasheet(myScenario, sheetData, sheetName)
```

**Probabilistic Transitions** define the transitions between State Classes and assigns a probability to each:
```{r}
# Add all the probabilistic transition pathways
sheetName <- "stsim_Transition"
sheetData <- datasheet(myScenario, sheetName, optional = T, empty = T)
sheetData <- addRow(sheetData, data.frame(StateClassIDSource = "Coniferous", 
                                          StateClassIDDest = "Deciduous", 
                                          TransitionTypeID = "Fire", 
                                          Probability = 0.01))
sheetData <- addRow(sheetData, data.frame(StateClassIDSource = "Coniferous",
                                          StateClassIDDest = "Deciduous", 
                                          TransitionTypeID = "Harvest", 
                                          Probability = 1, 
                                          AgeMin = 40))
sheetData <- addRow(sheetData, data.frame(StateClassIDSource = "Deciduous",
                                          StateClassIDDest = "Deciduous", 
                                          TransitionTypeID = "Fire", 
                                          Probability = 0.002))
sheetData <- addRow(sheetData, data.frame(StateClassIDSource = "Deciduous",
                                          StateClassIDDest = "Mixed", 
                                          TransitionTypeID = "Succession", 
                                          Probability = 0.1, 
                                          AgeMin = 10))
sheetData <- addRow(sheetData, data.frame(StateClassIDSource = "Mixed", 
                                          StateClassIDDest = "Deciduous", 
                                          TransitionTypeID = "Fire", 
                                          Probability = 0.005))
sheetData <- addRow(sheetData, data.frame(StateClassIDSource = "Mixed", 
                                          StateClassIDDest = "Coniferous",
                                          TransitionTypeID = "Succession", 
                                          Probability = 0.1, 
                                          AgeMin = 20))
saveDatasheet(myScenario, sheetData, sheetName)
```

**Initial Conditions** sets the starting conditions of the model at time 0. There are two options for setting initial conditions: either spatial or non-spatial. In this example we will use spatial initial conditions; however we demonstrate below how also to set initial conditions non-spatially.

* ***Initial Conditions: Option 1 - Spatial***. Let's first take a look at our rasters.

```{r, fig.align="center", fig.dim = c(5,5)}
rStratum <- raster(stratumTif)
rSclass <- raster(sclassTif)
rAge <- raster(ageTif)

plot(rStratum)
plot(rSclass)
plot(rAge)
```

We can add these rasters as model inputs using the `stsim_InitialConditionsSpatial` datasheet.

```{r}
sheetName <- "stsim_InitialConditionsSpatial"
sheetData <- list(StratumFileName = stratumTif, 
                  StateClassFileName = sclassTif, 
                  AgeFileName = ageTif)
saveDatasheet(myScenario, sheetData, sheetName)
```

Let's check if the rasters were entered correctly. We can extract rasters with `datasheetRaster` function.

```{r, fig.align="center", fig.dim = c(5,5), eval=FALSE}
rStratumTest <- datasheetRaster(myScenario, sheetName, "StratumFileName")
rSclassTest <- datasheetRaster(myScenario, sheetName, "StateClassFileName")
rAgeTest <- datasheetRaster(myScenario, sheetName, "AgeFileName")
plot(rStratumTest)
plot(rSclassTest)
plot(rAgeTest)
```

***Initial Conditions: Option 2 - Non-spatial***. The second option is to set the proportions of each class, making this a non-spatial parameterization. To do so we use the 
`stsim_InitialConditionsNonSpatial` and `stsim_InitialConditionsNonSpatialDistribution` datasheets:
```{r}
sheetName <- "stsim_InitialConditionsNonSpatial"
sheetData <- data.frame(TotalAmount = 100, 
                        NumCells = 100, 
                        CalcFromDist = F)
saveDatasheet(myScenario, sheetData, sheetName)
datasheet(myScenario, sheetName)

sheetName <- "stsim_InitialConditionsNonSpatialDistribution"
sheetData <- data.frame(StratumID = "Entire Forest", 
                        StateClassID = "Coniferous", 
                        RelativeAmount = 1)
saveDatasheet(myScenario, sheetData, sheetName)
datasheet(myScenario, sheetName)
```

**Transition Targets** defines targets, in units of area, to be reached by the allocation procedure within SyncroSim:
```{r}
# Transition targets - set harvest to 0 for this scenario
saveDatasheet(myScenario, 
              data.frame(TransitionGroupID = "Harvest", 
                         Amount = 0),
              "stsim_TransitionTarget")
```

**Output Options** regulates the model outputs and determines the frequency at which syncrosim saves the model outputs:
```{r}
# Output options
# datasheet(myScenario, "stsim_OutputOptions")
sheetData <- data.frame(
  SummaryOutputSC = T, SummaryOutputSCTimesteps = 1,
  SummaryOutputTR = T, SummaryOutputTRTimesteps = 1
)
saveDatasheet(myScenario, sheetData, "stsim_OutputOptions")
sheetData <- data.frame(
  RasterOutputSC = T, RasterOutputSCTimesteps = 1,
  RasterOutputTR = T, RasterOutputTRTimesteps = 1,
  RasterOutputAge = T, RasterOutputAgeTimesteps = 1
)
saveDatasheet(myScenario, sheetData, "stsim_OutputOptionsSpatial")
```

We are done parameterizing our simple "No Harvest" scenario. Let's now define a new scenario that implements forest harvesting. Below, we create a second "Harvest" scenario that is a copy of the first scenario, but with a harvest level of 20 acres/year.

```{r}
myScenarioHarvest <- scenario(myProject, 
                              scenario = "Harvest", 
                              sourceScenario = myScenario)
saveDatasheet(myScenarioHarvest, data.frame(TransitionGroupID = "Harvest", 
                                            Amount = 20), 
              "stsim_TransitionTarget")
```

We can display the harvest levels for both scenarios.

```{r}
datasheet(myProject, scenario = c("Harvest", "No Harvest"), 
          name = "stsim_TransitionTarget")
```

### Run Scenarios & View Results

We can now run the Scenario and look at the results. We run both Scenarios together; each Monte Carlo realization is run in parallel as a separate multiprocessing job. Running a Scenario generates a corresponding new child Scenario, called a *Results Scenario*, which contains the results of the run along with a snapshot of all the model inputs.

```{r}
resultSummary <- run(myProject, scenario = c("Harvest", "No Harvest"), 
                     jobs = 7, summary = TRUE)
```

To look at the results we first need to retrieve the unique `scenarioId` for each child *Result Scenario*.

```{r}
resultIDNoHarvest <- subset(resultSummary, 
                            parentID == scenarioId(myScenario))$scenarioId
resultIDHarvest <- subset(resultSummary, 
                          parentID == scenarioId(myScenarioHarvest))$scenarioId
```

We then can retrieve tabular output regarding the projected State Class over time (for both scenarios combined) from the `stsim_OutputStratumState` Datasheet.

```{r}
outputStratumState <- datasheet(myProject, 
                                scenario = c(resultIDNoHarvest, resultIDHarvest), 
                                name = "stsim_OutputStratumState")
```

Finally, we can get the State Class raster output (here for the Harvest scenario only).

```{r, fig.align = TRUE, fig.dim = c(5,5)}
myRastersTimestep5 <- datasheetRaster(myProject, 
                                      scenario = resultIDHarvest, 
                                      "stsim_OutputSpatialState", 
                                      timestep = 5)
# Plot raster for timestep 5 (first realization only)
myRastersTimestep5
plot(myRastersTimestep5[[1]])
```
